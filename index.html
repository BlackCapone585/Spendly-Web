<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Spendly ‚Äî –£—á—ë—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ====== CSS RESET & BASE ====== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --primary: #6C63FF;
  --primary-dark: #5A52D5;
  --primary-light: #8B85FF;
  --secondary: #FF6584;
  --accent: #00C9A7;
  --bg: #0F0F1A;
  --bg-card: #1A1A2E;
  --bg-card-hover: #222240;
  --bg-input: #16163A;
  --text: #EAEAEA;
  --text-secondary: #9E9EB8;
  --text-muted: #6B6B8D;
  --success: #00C9A7;
  --warning: #FFB830;
  --danger: #FF4757;
  --border: #2A2A4A;
  --shadow: 0 8px 32px rgba(0,0,0,0.3);
  --shadow-sm: 0 4px 12px rgba(0,0,0,0.2);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 8px;
  --font-heading: 'Unbounded', sans-serif;
  --font-ui: 'Rajdhani', sans-serif;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

html { font-size: 16px; }
body {
  font-family: var(--font-ui);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ====== SCROLLBAR ====== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

/* ====== UTILITY ====== */
.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.4s ease forwards; }
.fade-out { animation: fadeOut 0.3s ease forwards; }
.slide-up { animation: slideUp 0.4s ease forwards; }
.slide-down { animation: slideDown 0.3s ease forwards; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes progressFill { from { width: 0; } }
@keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes glow {
  0%,100% { box-shadow: 0 0 20px rgba(108,99,255,0.3); }
  50% { box-shadow: 0 0 40px rgba(108,99,255,0.6); }
}

/* ====== APP CONTAINER ====== */
.app-container {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  position: relative;
  background: var(--bg);
}

/* ====== SCREEN ====== */
.screen {
  min-height: 100vh;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
}
.screen.with-nav { padding-bottom: 90px; }

/* ====== SPLASH ====== */
#splash-screen {
  justify-content: center;
  align-items: center;
  text-align: center;
  background: linear-gradient(135deg, var(--bg) 0%, #1a1035 50%, var(--bg) 100%);
}
.splash-logo {
  width: 180px; height: 180px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 40px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-heading);
  font-size: 48px; font-weight: 900; color: white;
  margin-bottom: 32px;
  animation: float 3s ease-in-out infinite, glow 2s ease-in-out infinite;
  box-shadow: 0 20px 60px rgba(108,99,255,0.4);
}
.splash-title {
  font-family: var(--font-heading);
  font-size: 26px; font-weight: 700;
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--primary-light), var(--secondary));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.splash-subtitle {
  color: var(--text-secondary);
  font-size: 18px; font-weight: 500;
  margin-bottom: 48px;
}
.splash-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white; border: none;
  padding: 16px 48px; border-radius: 50px;
  font-family: var(--font-ui); font-size: 18px; font-weight: 600;
  cursor: pointer; transition: var(--transition);
  box-shadow: 0 8px 24px rgba(108,99,255,0.4);
}
.splash-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(108,99,255,0.5); }
.splash-btn:active { transform: translateY(0); }

/* ====== AUTH SCREEN ====== */
#auth-screen {
  justify-content: center;
  align-items: center;
  text-align: center;
}
.auth-image {
  width: 150px; height: 150px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 64px;
  margin-bottom: 24px;
  box-shadow: 0 12px 40px rgba(0,201,167,0.3);
}
.auth-title {
  font-family: var(--font-heading);
  font-size: 22px; font-weight: 700;
  margin-bottom: 8px;
}
.auth-subtitle {
  color: var(--text-secondary);
  font-size: 16px; margin-bottom: 32px;
}
.auth-form { width: 100%; max-width: 360px; }
.auth-tabs {
  display: flex; gap: 0;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 4px; margin-bottom: 24px;
}
.auth-tab {
  flex: 1; padding: 10px;
  background: transparent; border: none;
  color: var(--text-muted); font-family: var(--font-ui);
  font-size: 16px; font-weight: 600;
  cursor: pointer; border-radius: var(--radius-xs);
  transition: var(--transition);
}
.auth-tab.active {
  background: var(--primary);
  color: white;
}
.input-group { margin-bottom: 16px; text-align: left; }
.input-group label {
  display: block; font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 6px; font-weight: 600;
}
.input-group input, .input-group select, .input-group textarea {
  width: 100%; padding: 14px 16px;
  background: var(--bg-input);
  border: 2px solid var(--border);
  border-radius: var(--radius-xs);
  color: var(--text); font-family: var(--font-ui);
  font-size: 16px; font-weight: 500;
  transition: var(--transition);
  outline: none;
}
.input-group input:focus, .input-group select:focus, .input-group textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(108,99,255,0.15);
}
.input-group input::placeholder { color: var(--text-muted); }
.input-error { border-color: var(--danger) !important; }
.error-text { color: var(--danger); font-size: 13px; margin-top: 4px; display: none; }
.error-text.show { display: block; }

.btn {
  width: 100%; padding: 14px;
  border: none; border-radius: var(--radius-xs);
  font-family: var(--font-ui); font-size: 17px; font-weight: 600;
  cursor: pointer; transition: var(--transition);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 16px rgba(108,99,255,0.3);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(108,99,255,0.4); }
.btn-secondary {
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border);
}
.btn-secondary:hover { border-color: var(--primary); color: var(--text); }
.btn-danger {
  background: linear-gradient(135deg, var(--danger), #e8384f);
  color: white;
}
.btn-success {
  background: linear-gradient(135deg, var(--success), #00a88a);
  color: white;
}
.btn-ghost {
  background: transparent;
  color: var(--text-muted);
  text-decoration: underline;
}
.btn + .btn { margin-top: 12px; }
.btn-row { display: flex; gap: 12px; margin-top: 12px; }
.btn-row .btn { flex: 1; }

/* ====== MODAL ====== */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  backdrop-filter: blur(8px);
}
.modal-content {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 32px 24px;
  max-width: 400px; width: 100%;
  text-align: center;
  animation: slideUp 0.3s ease;
  border: 1px solid var(--border);
}
.modal-icon {
  width: 80px; height: 80px;
  margin: 0 auto 20px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 40px;
}
.modal-icon.warning {
  background: linear-gradient(135deg, var(--warning), #e6a320);
}
.modal-icon.success {
  background: linear-gradient(135deg, var(--success), #00a88a);
}
.modal-icon.danger {
  background: linear-gradient(135deg, var(--danger), #e8384f);
}
.modal-title {
  font-family: var(--font-heading);
  font-size: 20px; font-weight: 700;
  margin-bottom: 12px;
}
.modal-text {
  color: var(--text-secondary);
  font-size: 15px; line-height: 1.6;
  margin-bottom: 24px;
}

/* ====== BOTTOM NAV ====== */
.bottom-nav {
  position: fixed; bottom: 0; left: 50%;
  transform: translateX(-50%);
  max-width: 480px; width: 100%;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
  display: flex; padding: 8px 0 12px;
  z-index: 100;
  backdrop-filter: blur(20px);
}
.nav-item {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  background: none; border: none;
  color: var(--text-muted); cursor: pointer;
  font-family: var(--font-ui); font-size: 11px; font-weight: 600;
  transition: var(--transition);
  padding: 4px 0;
}
.nav-item.active { color: var(--primary); }
.nav-item .nav-icon {
  font-size: 24px; line-height: 1;
  transition: var(--transition);
}
.nav-item.active .nav-icon { transform: scale(1.1); }

/* ====== HEADER ====== */
.page-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px;
}
.page-title {
  font-family: var(--font-heading);
  font-size: 22px; font-weight: 700;
}
.page-title span { color: var(--primary); }

/* ====== BALANCE CARD ====== */
.balance-card {
  background: linear-gradient(135deg, var(--primary), #4834d4);
  border-radius: var(--radius);
  padding: 28px 24px;
  margin-bottom: 24px;
  position: relative; overflow: hidden;
}
.balance-card::before {
  content: '';
  position: absolute; top: -50px; right: -50px;
  width: 150px; height: 150px;
  background: rgba(255,255,255,0.08);
  border-radius: 50%;
}
.balance-card::after {
  content: '';
  position: absolute; bottom: -30px; left: -30px;
  width: 100px; height: 100px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
}
.balance-label {
  font-size: 14px; color: rgba(255,255,255,0.7);
  font-weight: 600; margin-bottom: 8px;
}
.balance-amount {
  font-family: var(--font-heading);
  font-size: 36px; font-weight: 900;
  color: white; margin-bottom: 16px;
}
.balance-row {
  display: flex; gap: 16px;
}
.balance-item {
  flex: 1; padding: 12px;
  background: rgba(255,255,255,0.12);
  border-radius: var(--radius-xs);
  backdrop-filter: blur(10px);
}
.balance-item-label {
  font-size: 12px; color: rgba(255,255,255,0.6);
  margin-bottom: 4px;
}
.balance-item-value {
  font-size: 18px; font-weight: 700;
  color: white;
}
.balance-item-value.income { color: #7dffcc; }
.balance-item-value.expense { color: #ff9fae; }

/* ====== CHART SECTION ====== */
.chart-section {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
  border: 1px solid var(--border);
}
.chart-title {
  font-family: var(--font-heading);
  font-size: 16px; font-weight: 700;
  margin-bottom: 16px;
}
.chart-container {
  position: relative;
  height: 220px;
  display: flex; align-items: center; justify-content: center;
}
.chart-empty {
  text-align: center;
  color: var(--text-muted);
  font-size: 15px;
}
.chart-empty-icon { font-size: 48px; margin-bottom: 12px; }

/* ====== CATEGORIES ====== */
.categories-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px; margin-bottom: 24px;
}
.category-item {
  display: flex; flex-direction: column;
  align-items: center; gap: 6px;
  padding: 12px 8px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  cursor: pointer; transition: var(--transition);
  text-decoration: none; color: var(--text);
}
.category-item:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}
.category-icon {
  font-size: 28px; line-height: 1;
}
.category-name {
  font-size: 11px; font-weight: 600;
  color: var(--text-secondary);
  text-align: center;
}

/* ====== TRANSACTION LIST ====== */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.section-title {
  font-family: var(--font-heading);
  font-size: 16px; font-weight: 700;
}
.section-link {
  color: var(--primary); font-size: 14px;
  font-weight: 600; cursor: pointer;
  background: none; border: none;
  font-family: var(--font-ui);
}
.transaction-list { display: flex; flex-direction: column; gap: 10px; }
.transaction-item {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 16px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  transition: var(--transition);
  cursor: pointer;
}
.transaction-item:hover { border-color: var(--primary); }
.transaction-icon-wrap {
  width: 44px; height: 44px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.transaction-info { flex: 1; min-width: 0; }
.transaction-category {
  font-size: 15px; font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.transaction-date {
  font-size: 13px; color: var(--text-muted);
  margin-top: 2px;
}
.transaction-amount {
  font-size: 17px; font-weight: 700;
  white-space: nowrap;
}
.transaction-amount.expense { color: var(--danger); }
.transaction-amount.income { color: var(--success); }
.transaction-comment {
  font-size: 12px; color: var(--text-muted);
  margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.empty-state {
  text-align: center; padding: 40px 20px;
  color: var(--text-muted);
}
.empty-state-icon { font-size: 56px; margin-bottom: 16px; }
.empty-state-text { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
.empty-state-sub { font-size: 14px; color: var(--text-muted); }

/* ====== FAB ====== */
.fab {
  position: fixed;
  bottom: 80px; right: calc(50% - 210px);
  width: 56px; height: 56px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none; border-radius: 50%;
  color: white; font-size: 28px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 50;
  box-shadow: 0 8px 24px rgba(108,99,255,0.4);
  transition: var(--transition);
}
.fab:hover { transform: scale(1.1); }
@media (max-width: 480px) {
  .fab { right: 20px; }
}

/* ====== ADD FORM (MODAL) ====== */
.form-modal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 200;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}
.form-modal-inner {
  max-width: 480px;
  margin: 0 auto;
  padding: 24px 20px;
}
.form-header {
  display: flex; align-items: center; gap: 16px;
  margin-bottom: 24px;
}
.form-back {
  background: var(--bg-card); border: none;
  width: 40px; height: 40px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; cursor: pointer;
  color: var(--text); transition: var(--transition);
}
.form-back:hover { background: var(--bg-card-hover); }
.form-title {
  font-family: var(--font-heading);
  font-size: 20px; font-weight: 700;
}

/* ====== FILTER TABS ====== */
.filter-tabs {
  display: flex; gap: 8px;
  margin-bottom: 20px;
  overflow-x: auto;
  padding-bottom: 4px;
}
.filter-tab {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 50px;
  font-family: var(--font-ui);
  font-size: 14px; font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer; white-space: nowrap;
  transition: var(--transition);
}
.filter-tab.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

/* ====== CREDIT CARD ====== */
.credit-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: var(--transition);
}
.credit-card:hover { border-color: var(--primary); }
.credit-card-header {
  display: flex; justify-content: space-between;
  align-items: flex-start; margin-bottom: 12px;
}
.credit-name {
  font-family: var(--font-heading);
  font-size: 16px; font-weight: 700;
}
.credit-bank {
  font-size: 13px; color: var(--text-muted);
  margin-top: 2px;
}
.credit-badge {
  padding: 4px 10px;
  border-radius: 50px;
  font-size: 12px; font-weight: 600;
}
.credit-badge.active { background: rgba(0,201,167,0.15); color: var(--success); }
.credit-badge.completed { background: rgba(108,99,255,0.15); color: var(--primary); }
.credit-stats {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 12px; margin-bottom: 16px;
}
.credit-stat-label {
  font-size: 12px; color: var(--text-muted);
  margin-bottom: 2px;
}
.credit-stat-value {
  font-size: 16px; font-weight: 700;
}
.credit-progress { margin-top: 4px; }
.progress-bar-bg {
  height: 8px; background: var(--bg);
  border-radius: 4px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
  animation: progressFill 0.8s ease;
}
.progress-bar-fill.green { background: linear-gradient(90deg, var(--success), #7dffcc); }
.progress-bar-fill.yellow { background: linear-gradient(90deg, var(--warning), #ffe066); }
.progress-bar-fill.red { background: linear-gradient(90deg, var(--danger), #ff9fae); }
.progress-text {
  display: flex; justify-content: space-between;
  font-size: 12px; color: var(--text-muted);
  margin-top: 6px;
}

/* ====== SCHEDULE TABLE ====== */
.schedule-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.schedule-table th {
  text-align: left;
  padding: 10px 8px;
  border-bottom: 2px solid var(--border);
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 12px;
}
.schedule-table td {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border);
}
.schedule-table tr:last-child td { border-bottom: none; }

/* ====== SETTINGS ====== */
.settings-group {
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 16px;
}
.settings-item {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: var(--transition);
  background: none; border-left: none; border-right: none; border-top: none;
  width: 100%; text-align: left;
  font-family: var(--font-ui); color: var(--text);
  font-size: 16px; font-weight: 500;
}
.settings-item:last-child { border-bottom: none; }
.settings-item:hover { background: var(--bg-card-hover); }
.settings-icon { font-size: 22px; width: 32px; text-align: center; }
.settings-label { flex: 1; }
.settings-arrow { color: var(--text-muted); font-size: 18px; }
.settings-item.danger { color: var(--danger); }

.user-card {
  display: flex; align-items: center; gap: 16px;
  padding: 24px;
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: 16px;
}
.user-avatar {
  width: 56px; height: 56px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; font-weight: 700;
  color: white; font-family: var(--font-heading);
}
.user-name {
  font-family: var(--font-heading);
  font-size: 18px; font-weight: 700;
}
.user-email {
  font-size: 14px; color: var(--text-muted);
  margin-top: 2px;
}

/* ====== CHECKBOX ====== */
.checkbox-group {
  display: flex; align-items: flex-start; gap: 10px;
  margin: 16px 0;
  cursor: pointer;
}
.checkbox-group input[type="checkbox"] {
  width: 20px; height: 20px;
  accent-color: var(--primary);
  margin-top: 2px;
  flex-shrink: 0;
}
.checkbox-label {
  font-size: 14px; color: var(--text-secondary);
  line-height: 1.5;
}

/* ====== TOAST ====== */
.toast {
  position: fixed; top: 20px; left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 24px;
  display: flex; align-items: center; gap: 10px;
  z-index: 9999;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
  animation: slideDown 0.3s ease;
  max-width: 90%; font-weight: 600;
}
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
.toast.info { border-color: var(--primary); }

/* ====== CHART BAR (custom) ====== */
.bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 180px; padding-top: 20px; }
.bar-item {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: flex-end; height: 100%;
}
.bar-fill {
  width: 100%; min-height: 4px;
  border-radius: 6px 6px 0 0;
  transition: height 0.5s ease;
}
.bar-label {
  font-size: 11px; color: var(--text-muted);
  margin-top: 8px; text-align: center;
}
.bar-value {
  font-size: 11px; font-weight: 600;
  margin-bottom: 4px; white-space: nowrap;
}

/* ====== RESPONSIVE ====== */
@media (min-width: 481px) {
  .app-container {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }
}
</style>
</head>
<body>

<div class="app-container" id="app">

  <!-- ====== SPLASH SCREEN ====== -->
  <div class="screen" id="splash-screen">
    <div class="splash-logo">S</div>
    <h1 class="splash-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Spendly!</h1>
    <p class="splash-subtitle">–£–º–Ω—ã–π —É—á—ë—Ç –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤</p>
    <button class="splash-btn" onclick="showAuth()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  </div>

  <!-- ====== AUTH SCREEN ====== -->
  <div class="screen hidden" id="auth-screen">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
      <div class="auth-image">üîê</div>
      <h2 class="auth-title">–í—Ö–æ–¥ –≤ Spendly</h2>
      <p class="auth-subtitle">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Å –ª—ë–≥–∫–æ—Å—Ç—å—é</p>

      <div class="auth-form">
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
          <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div id="auth-name-group" class="input-group hidden">
          <label>–ò–º—è</label>
          <input type="text" id="auth-name" placeholder="–í–∞—à–µ –∏–º—è" minlength="3">
          <div class="error-text" id="name-error">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</div>
        </div>

        <div class="input-group">
          <label>–ü–æ—á—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="text" id="auth-email" placeholder="email@example.com">
          <div class="error-text" id="email-error">–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
        </div>

        <div class="input-group">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="auth-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6">
          <div class="error-text" id="password-error">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
        </div>

        <button class="btn btn-primary" onclick="handleAuth()" id="auth-submit-btn">–í–æ–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="showGuestWarning()">
          <span>üë§</span> –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- ====== MAIN SCREENS (with nav) ====== -->
  <!-- HOME -->
  <div class="screen with-nav hidden" id="home-screen">
    <div class="page-header">
      <h1 class="page-title" id="greeting">–ü—Ä–∏–≤–µ—Ç! üëã</h1>
      <button onclick="showAddExpenseForm()" style="background:var(--primary);border:none;border-radius:12px;width:40px;height:40px;color:white;font-size:22px;cursor:pointer;">+</button>
    </div>

    <div class="balance-card">
      <div class="balance-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="balance-amount" id="total-balance">0 ‚ÇΩ</div>
      <div class="balance-row">
        <div class="balance-item">
          <div class="balance-item-label">üìà –î–æ—Ö–æ–¥—ã</div>
          <div class="balance-item-value income" id="total-income">0 ‚ÇΩ</div>
        </div>
        <div class="balance-item">
          <div class="balance-item-label">üìâ –†–∞—Å—Ö–æ–¥—ã</div>
          <div class="balance-item-value expense" id="total-expense">0 ‚ÇΩ</div>
        </div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
      <div class="chart-container" id="pie-chart-container">
        <canvas id="pieChart"></canvas>
        <div class="chart-empty" id="chart-empty">
          <div class="chart-empty-icon">üìä</div>
          <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
        </div>
      </div>
    </div>

    <div class="categories-grid">
      <div class="category-item" onclick="filterByCategory('–ï–¥–∞')"><span class="category-icon">üçî</span><span class="category-name">–ï–¥–∞</span></div>
      <div class="category-item" onclick="filterByCategory('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç')"><span class="category-icon">üöó</span><span class="category-name">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span></div>
      <div class="category-item" onclick="filterByCategory('–ñ–∏–ª—å—ë')"><span class="category-icon">üè†</span><span class="category-name">–ñ–∏–ª—å—ë</span></div>
      <div class="category-item" onclick="filterByCategory('–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è')"><span class="category-icon">üéÆ</span><span class="category-name">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</span></div>
      <div class="category-item" onclick="filterByCategory('–ó–¥–æ—Ä–æ–≤—å–µ')"><span class="category-icon">üíä</span><span class="category-name">–ó–¥–æ—Ä–æ–≤—å–µ</span></div>
      <div class="category-item" onclick="filterByCategory('–û–¥–µ–∂–¥–∞')"><span class="category-icon">üëï</span><span class="category-name">–û–¥–µ–∂–¥–∞</span></div>
      <div class="category-item" onclick="filterByCategory('–ö—Ä–µ–¥–∏—Ç')"><span class="category-icon">üè¶</span><span class="category-name">–ö—Ä–µ–¥–∏—Ç</span></div>
      <div class="category-item" onclick="filterByCategory('–ü—Ä–æ—á–µ–µ')"><span class="category-icon">üì¶</span><span class="category-name">–ü—Ä–æ—á–µ–µ</span></div>
    </div>

    <div class="section-header">
      <h3 class="section-title">–ù–µ–¥–∞–≤–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
      <button class="section-link" onclick="switchTab('expenses')">–í—Å–µ ‚Üí</button>
    </div>
    <div class="transaction-list" id="recent-transactions"></div>
  </div>

  <!-- INCOME -->
  <div class="screen with-nav hidden" id="income-screen">
    <div class="page-header">
      <h1 class="page-title">üí∞ –î–æ—Ö–æ–¥—ã</h1>
      <button onclick="showAddIncomeForm()" style="background:var(--success);border:none;border-radius:12px;width:40px;height:40px;color:white;font-size:22px;cursor:pointer;">+</button>
    </div>

    <div class="balance-card" style="background:linear-gradient(135deg, var(--success), #009b7d);">
      <div class="balance-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
      <div class="balance-amount" id="income-total-display">0 ‚ÇΩ</div>
    </div>

    <div class="section-header">
      <h3 class="section-title">–í—Å–µ –¥–æ—Ö–æ–¥—ã</h3>
    </div>
    <div class="transaction-list" id="income-list"></div>
  </div>

  <!-- CREDITS -->
  <div class="screen with-nav hidden" id="credits-screen">
    <div class="page-header">
      <h1 class="page-title">üè¶ –ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã</h1>
      <button onclick="showAddCreditForm()" style="background:var(--primary);border:none;border-radius:12px;width:40px;height:40px;color:white;font-size:22px;cursor:pointer;">+</button>
    </div>

    <div class="filter-tabs" id="credit-filter-tabs">
      <button class="filter-tab active" onclick="filterCredits('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
      <button class="filter-tab" onclick="filterCredits('completed')">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
      <button class="filter-tab" onclick="filterCredits('all')">–í—Å–µ</button>
    </div>

    <div id="credits-list"></div>
  </div>

  <!-- EXPENSES -->
  <div class="screen with-nav hidden" id="expenses-screen">
    <div class="page-header">
      <h1 class="page-title">üìä –û–±—â–∏–µ —Ç—Ä–∞—Ç—ã</h1>
    </div>

    <div class="filter-tabs" id="period-filter-tabs">
      <button class="filter-tab active" onclick="filterPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="filter-tab" onclick="filterPeriod('month')">–ú–µ—Å—è—Ü</button>
      <button class="filter-tab" onclick="filterPeriod('year')">–ì–æ–¥</button>
      <button class="filter-tab" onclick="filterPeriod('all')">–í—Å–µ</button>
    </div>

    <div class="chart-section">
      <div class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
    </div>

    <div class="section-header">
      <h3 class="section-title">–°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
      <span class="section-link" id="expense-count">0 –∑–∞–ø–∏—Å–µ–π</span>
    </div>
    <div class="transaction-list" id="full-expense-list"></div>
  </div>

  <!-- SETTINGS -->
  <div class="screen with-nav hidden" id="settings-screen">
    <div class="page-header">
      <h1 class="page-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
    </div>

    <div class="user-card" id="user-card">
      <div class="user-avatar" id="user-avatar">?</div>
      <div>
        <div class="user-name" id="user-display-name">–ì–æ—Å—Ç—å</div>
        <div class="user-email" id="user-display-email">–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º</div>
      </div>
    </div>

    <div class="settings-group">
      <button class="settings-item" onclick="exportCSV()">
        <span class="settings-icon">üìÑ</span>
        <span class="settings-label">–°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã (.csv)</span>
        <span class="settings-arrow">‚Üí</span>
      </button>
      <button class="settings-item" onclick="exportJSON()">
        <span class="settings-icon">üìã</span>
        <span class="settings-label">–°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã (.json)</span>
        <span class="settings-arrow">‚Üí</span>
      </button>
      <button class="settings-item" onclick="exportLogs()">
        <span class="settings-icon">üìù</span>
        <span class="settings-label">–°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏ (.txt)</span>
        <span class="settings-arrow">‚Üí</span>
      </button>
    </div>

    <div class="settings-group">
      <button class="settings-item" onclick="triggerImport()">
        <span class="settings-icon">üì•</span>
        <span class="settings-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (.csv/.json)</span>
        <span class="settings-arrow">‚Üí</span>
      </button>
      <input type="file" id="import-file" accept=".csv,.json" style="display:none" onchange="importData(event)">
    </div>

    <div class="settings-group">
      <button class="settings-item" onclick="toggleNotifications()">
        <span class="settings-icon">üîî</span>
        <span class="settings-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        <span class="settings-arrow" id="notif-status">–í–∫–ª</span>
      </button>
    </div>

    <div class="settings-group">
      <button class="settings-item danger" onclick="showLogoutConfirm()">
        <span class="settings-icon">üö™</span>
        <span class="settings-label">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</span>
        <span class="settings-arrow">‚Üí</span>
      </button>
    </div>

    <p style="text-align:center; color:var(--text-muted); font-size:13px; margin-top:24px;">
      Spendly v1.0 ‚Ä¢ –£—á—ë—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤<br>
      ¬© 2025 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã
    </p>
  </div>

  <!-- ====== BOTTOM NAV ====== -->
  <nav class="bottom-nav hidden" id="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')">
      <span class="nav-icon">üè†</span>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-item" onclick="switchTab('income')">
      <span class="nav-icon">üí∞</span>
      <span>–î–æ—Ö–æ–¥—ã</span>
    </button>
    <button class="nav-item" onclick="switchTab('credits')">
      <span class="nav-icon">üè¶</span>
      <span>–ö—Ä–µ–¥–∏—Ç—ã</span>
    </button>
    <button class="nav-item" onclick="switchTab('expenses')">
      <span class="nav-icon">üìä</span>
      <span>–¢—Ä–∞—Ç—ã</span>
    </button>
    <button class="nav-item" onclick="switchTab('settings')">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span>–ï—â—ë</span>
    </button>
  </nav>

</div>

<!-- ====== MODALS CONTAINER ====== -->
<div id="modals-container"></div>

<script>
// ============================
// DATA STORE
// ============================
const STORE_KEY = 'spendly_data';
const LOG_KEY = 'spendly_logs';

let appData = {
  user: null, // { name, email, isGuest }
  expenses: [],
  incomes: [],
  credits: [],
  settings: { notifications: true }
};

let logs = [];
let pieChart = null;
let barChart = null;
let currentCreditFilter = 'active';
let currentPeriodFilter = 'month';

// Category config
const CATEGORIES = {
  '–ï–¥–∞':          { icon: 'üçî', color: '#FF6384' },
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':    { icon: 'üöó', color: '#36A2EB' },
  '–ñ–∏–ª—å—ë':        { icon: 'üè†', color: '#FFCE56' },
  '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è':  { icon: 'üéÆ', color: '#4BC0C0' },
  '–ó–¥–æ—Ä–æ–≤—å–µ':     { icon: 'üíä', color: '#9966FF' },
  '–û–¥–µ–∂–¥–∞':       { icon: 'üëï', color: '#FF9F40' },
  '–ö—Ä–µ–¥–∏—Ç':       { icon: 'üè¶', color: '#C9CBCF' },
  '–ü—Ä–æ—á–µ–µ':       { icon: 'üì¶', color: '#7C8DB0' }
};

// ============================
// PERSISTENCE
// ============================
function saveData() {
  localStorage.setItem(STORE_KEY, JSON.stringify(appData));
}
function loadData() {
  const raw = localStorage.getItem(STORE_KEY);
  if (raw) {
    try {
      appData = JSON.parse(raw);
    } catch(e) {
      console.error('Load error', e);
    }
  }
  const rawLogs = localStorage.getItem(LOG_KEY);
  if (rawLogs) {
    try { logs = JSON.parse(rawLogs); } catch(e) {}
  }
}
function addLog(msg) {
  const entry = `[${new Date().toLocaleString('ru-RU')}] ${msg}`;
  logs.push(entry);
  if (logs.length > 500) logs = logs.slice(-500);
  localStorage.setItem(LOG_KEY, JSON.stringify(logs));
}

// ============================
// UTILITY
// ============================
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
function formatMoney(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n) + ' ‚ÇΩ';
}
function formatDate(d) {
  return new Date(d).toLocaleDateString('ru-RU', { day:'numeric', month:'short', year:'numeric' });
}
function formatDateShort(d) {
  return new Date(d).toLocaleDateString('ru-RU', { day:'numeric', month:'short' });
}

// ============================
// TOAST
// ============================
function showToast(msg, type='info') {
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è' };
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${icons[type]||''}</span><span>${msg}</span>`;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(-20px)'; setTimeout(() => t.remove(), 300); }, 2500);
}

// ============================
// MODAL HELPER
// ============================
function showModal(html) {
  const container = document.getElementById('modals-container');
  container.innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">${html}</div>`;
}
function closeModal() {
  document.getElementById('modals-container').innerHTML = '';
}

// ============================
// SCREENS
// ============================
function hideAllScreens() {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
}
function showScreen(id) {
  hideAllScreens();
  document.getElementById(id).classList.remove('hidden');
  document.getElementById(id).classList.add('fade-in');
}

// ============================
// SPLASH
// ============================
function showAuth() {
  loadData();
  if (appData.user) {
    enterApp();
    return;
  }
  showScreen('auth-screen');
  addLog('–û—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
}

// Auto-advance splash after 2s
setTimeout(() => {
  if (!document.getElementById('splash-screen').classList.contains('hidden')) {
    showAuth();
  }
}, 3000);

// ============================
// AUTH
// ============================
let authMode = 'login';

function switchAuthTab(mode) {
  authMode = mode;
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0 && mode==='login') || (i===1 && mode==='register'));
  });
  document.getElementById('auth-name-group').classList.toggle('hidden', mode === 'login');
  document.getElementById('auth-submit-btn').textContent = mode === 'login' ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
}

function handleAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const name = document.getElementById('auth-name').value.trim();

  // Reset errors
  document.querySelectorAll('.error-text').forEach(e => e.classList.remove('show'));
  document.querySelectorAll('.input-group input').forEach(e => e.classList.remove('input-error'));

  let valid = true;

  if (!email || (!email.includes('@') && !/^\+?\d{10,}$/.test(email.replace(/[\s\-()]/g,'')))) {
    document.getElementById('email-error').classList.add('show');
    document.getElementById('auth-email').classList.add('input-error');
    valid = false;
  }
  if (password.length < 6) {
    document.getElementById('password-error').classList.add('show');
    document.getElementById('auth-password').classList.add('input-error');
    valid = false;
  }
  if (authMode === 'register' && name.length < 3) {
    document.getElementById('name-error').classList.add('show');
    document.getElementById('auth-name').classList.add('input-error');
    valid = false;
  }
  if (!valid) return;

  const userName = authMode === 'register' ? name : (email.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
  appData.user = { name: userName, email: email, isGuest: false };
  saveData();
  addLog(`${authMode === 'login' ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}: ${email}`);
  showToast(authMode === 'login' ? '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
  enterApp();
}

function showGuestWarning() {
  showModal(`
    <div class="modal-content">
      <div class="modal-icon warning">‚ö†Ô∏è</div>
      <h3 class="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ!</h3>
      <p class="modal-text">–ï—Å–ª–∏ –≤—ã –Ω–µ –≤–æ–π–¥—ë—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —Ç–æ –¥–∞–ª—å—à–µ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç—Ä–∞—Ç—ã –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–≤–∞–π—Å. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
      <label class="checkbox-group">
        <input type="checkbox" id="guest-agree">
        <span class="checkbox-label">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω(-–Ω–∞) —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø–æ–Ω–∏–º–∞—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞</span>
      </label>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="acceptGuest()">–°–æ–≥–ª–∞—à–∞—é—Å—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `);
}

function acceptGuest() {
  const agreed = document.getElementById('guest-agree');
  if (!agreed.checked) {
    showToast('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏', 'error');
    return;
  }
  appData.user = { name: '–ì–æ—Å—Ç—å', email: '', isGuest: true };
  saveData();
  addLog('–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥');
  closeModal();
  showToast('–í—Ö–æ–¥ –∫–∞–∫ –≥–æ—Å—Ç—å', 'info');
  enterApp();
}

// ============================
// ENTER APP
// ============================
function enterApp() {
  document.getElementById('bottom-nav').classList.remove('hidden');
  switchTab('home');
  updateUI();
}

// ============================
// NAVIGATION
// ============================
function switchTab(tab) {
  hideAllScreens();
  const screenMap = { home:'home-screen', income:'income-screen', credits:'credits-screen', expenses:'expenses-screen', settings:'settings-screen' };
  const scr = document.getElementById(screenMap[tab]);
  if (scr) {
    scr.classList.remove('hidden');
    scr.classList.add('fade-in');
  }
  document.querySelectorAll('.nav-item').forEach((item, i) => {
    const tabs = ['home','income','credits','expenses','settings'];
    item.classList.toggle('active', tabs[i] === tab);
  });
  updateUI();
  addLog(`–ü–µ—Ä–µ—Ö–æ–¥: ${tab}`);
}

// ============================
// UPDATE UI
// ============================
function updateUI() {
  if (!appData.user) return;

  // Greeting
  document.getElementById('greeting').innerHTML = `–ü—Ä–∏–≤–µ—Ç, <span>${appData.user.name}</span>! üëã`;

  // Balance
  const totalIncome = appData.incomes.reduce((s,i) => s + i.amount, 0);
  const totalExpense = appData.expenses.reduce((s,e) => s + e.amount, 0);
  const balance = totalIncome - totalExpense;

  document.getElementById('total-balance').textContent = formatMoney(balance);
  document.getElementById('total-income').textContent = formatMoney(totalIncome);
  document.getElementById('total-expense').textContent = formatMoney(totalExpense);
  document.getElementById('income-total-display').textContent = formatMoney(totalIncome);

  // Recent transactions (last 5)
  renderRecentTransactions();
  renderPieChart();
  renderIncomeList();
  renderCreditsList();
  renderExpensesList();
  renderBarChart();
  updateSettingsUI();
}

// ============================
// RECENT TRANSACTIONS
// ============================
function renderRecentTransactions() {
  const container = document.getElementById('recent-transactions');
  const all = [
    ...appData.expenses.map(e => ({...e, type:'expense'})),
    ...appData.incomes.map(i => ({...i, type:'income'}))
  ].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);

  if (all.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí∏</div>
        <p class="empty-state-text">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>
        <p class="empty-state-sub">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å</p>
      </div>`;
    return;
  }

  container.innerHTML = all.map(t => {
    const cat = CATEGORIES[t.category] || CATEGORIES['–ü—Ä–æ—á–µ–µ'];
    const isIncome = t.type === 'income';
    return `
      <div class="transaction-item" onclick="showTransactionDetail('${t.id}','${t.type}')">
        <div class="transaction-icon-wrap" style="background:${isIncome ? 'rgba(0,201,167,0.15)' : (cat.color+'22')}">
          ${isIncome ? 'üí∞' : cat.icon}
        </div>
        <div class="transaction-info">
          <div class="transaction-category">${isIncome ? (t.source||'–î–æ—Ö–æ–¥') : t.category}</div>
          <div class="transaction-date">${formatDate(t.date)}</div>
          ${t.comment ? `<div class="transaction-comment">${t.comment}</div>` : ''}
        </div>
        <div class="transaction-amount ${t.type}">${isIncome?'+':'‚àí'}${formatMoney(t.amount)}</div>
      </div>`;
  }).join('');
}

// ============================
// PIE CHART
// ============================
function renderPieChart() {
  const canvas = document.getElementById('pieChart');
  const emptyDiv = document.getElementById('chart-empty');

  if (appData.expenses.length === 0) {
    canvas.style.display = 'none';
    emptyDiv.classList.remove('hidden');
    if (pieChart) { pieChart.destroy(); pieChart = null; }
    return;
  }
  canvas.style.display = 'block';
  emptyDiv.classList.add('hidden');

  const byCategory = {};
  appData.expenses.forEach(e => {
    byCategory[e.category] = (byCategory[e.category]||0) + e.amount;
  });
  const labels = Object.keys(byCategory);
  const data = Object.values(byCategory);
  const colors = labels.map(l => (CATEGORIES[l]||CATEGORIES['–ü—Ä–æ—á–µ–µ']).color);

  if (pieChart) pieChart.destroy();
  pieChart = new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels, datasets: [{
        data, backgroundColor: colors,
        borderWidth: 0, hoverOffset: 8
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#9E9EB8', font: { family: 'Rajdhani', size: 13, weight: '600' }, padding: 12, usePointStyle: true, pointStyleWidth: 10 }
        }
      }
    }
  });
}

// ============================
// BAR CHART
// ============================
function renderBarChart() {
  const canvas = document.getElementById('barChart');
  let filtered = filterExpensesByPeriod(appData.expenses);

  const byDate = {};
  filtered.forEach(e => {
    const key = formatDateShort(e.date);
    byDate[key] = (byDate[key]||0) + e.amount;
  });

  const labels = Object.keys(byDate).slice(-12);
  const data = labels.map(l => byDate[l]);

  if (barChart) barChart.destroy();
  barChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels, datasets: [{
        data,
        backgroundColor: 'rgba(108,99,255,0.6)',
        borderRadius: 6,
        borderSkipped: false,
        barThickness: 20,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#6B6B8D', font: { family:'Rajdhani', size: 11 } } },
        y: { grid: { color: '#2A2A4A' }, ticks: { color: '#6B6B8D', font: { family:'Rajdhani', size: 11 }, callback: v => v.toLocaleString() + '‚ÇΩ' } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function filterExpensesByPeriod(expenses) {
  const now = new Date();
  return expenses.filter(e => {
    const d = new Date(e.date);
    switch(currentPeriodFilter) {
      case 'week': return (now - d) < 7*24*60*60*1000;
      case 'month': return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      case 'year': return d.getFullYear() === now.getFullYear();
      default: return true;
    }
  });
}

function filterPeriod(period) {
  currentPeriodFilter = period;
  document.querySelectorAll('#period-filter-tabs .filter-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderBarChart();
  renderExpensesList();
}

function filterByCategory(cat) {
  switchTab('expenses');
  // Auto filter ‚Äî just scroll, show filtered list
  renderExpensesList(cat);
  showToast(`–§–∏–ª—å—Ç—Ä: ${cat}`, 'info');
}

// ============================
// INCOME LIST
// ============================
function renderIncomeList() {
  const container = document.getElementById('income-list');
  const sorted = [...appData.incomes].sort((a,b) => new Date(b.date) - new Date(a.date));

  if (sorted.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí∞</div>
        <p class="empty-state-text">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤</p>
        <p class="empty-state-sub">–î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –¥–æ—Ö–æ–¥</p>
      </div>`;
    return;
  }

  container.innerHTML = sorted.map(i => `
    <div class="transaction-item" onclick="showTransactionDetail('${i.id}','income')">
      <div class="transaction-icon-wrap" style="background:rgba(0,201,167,0.15)">üí∞</div>
      <div class="transaction-info">
        <div class="transaction-category">${i.source || '–î–æ—Ö–æ–¥'}</div>
        <div class="transaction-date">${formatDate(i.date)}</div>
      </div>
      <div class="transaction-amount income">+${formatMoney(i.amount)}</div>
    </div>
  `).join('');
}

// ============================
// EXPENSES LIST
// ============================
function renderExpensesList(categoryFilter) {
  const container = document.getElementById('full-expense-list');
  let filtered = filterExpensesByPeriod(appData.expenses);
  if (categoryFilter) filtered = filtered.filter(e => e.category === categoryFilter);
  const sorted = filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

  document.getElementById('expense-count').textContent = `${sorted.length} –∑–∞–ø–∏—Å–µ–π`;

  if (sorted.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <p class="empty-state-text">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</p>
      </div>`;
    return;
  }

  container.innerHTML = sorted.map(e => {
    const cat = CATEGORIES[e.category] || CATEGORIES['–ü—Ä–æ—á–µ–µ'];
    return `
      <div class="transaction-item" onclick="showTransactionDetail('${e.id}','expense')">
        <div class="transaction-icon-wrap" style="background:${cat.color}22">${cat.icon}</div>
        <div class="transaction-info">
          <div class="transaction-category">${e.category}${e.place ? ' ‚Ä¢ '+e.place : ''}</div>
          <div class="transaction-date">${formatDate(e.date)}</div>
          ${e.comment ? `<div class="transaction-comment">${e.comment}</div>` : ''}
        </div>
        <div class="transaction-amount expense">‚àí${formatMoney(e.amount)}</div>
      </div>`;
  }).join('');
}

// ============================
// CREDITS LIST
// ============================
function renderCreditsList() {
  const container = document.getElementById('credits-list');
  let filtered = appData.credits;

  if (currentCreditFilter === 'active') filtered = filtered.filter(c => c.isActive);
  else if (currentCreditFilter === 'completed') filtered = filtered.filter(c => !c.isActive);

  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üè¶</div>
        <p class="empty-state-text">–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤</p>
        <p class="empty-state-sub">–î–æ–±–∞–≤—å—Ç–µ –∫—Ä–µ–¥–∏—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</p>
      </div>`;
    return;
  }

  container.innerHTML = filtered.map(c => {
    const paid = c.totalAmount - c.remainingAmount;
    const percent = c.totalAmount > 0 ? Math.round((paid / c.totalAmount) * 100) : 0;
    let barClass = 'green';
    if (percent > 50 && percent <= 90) barClass = 'yellow';
    if (percent > 90) barClass = 'red';

    return `
      <div class="credit-card" onclick="showCreditDetail('${c.id}')">
        <div class="credit-card-header">
          <div>
            <div class="credit-name">${c.name}</div>
            ${c.bank ? `<div class="credit-bank">${c.bank}</div>` : ''}
          </div>
          <span class="credit-badge ${c.isActive ? 'active' : 'completed'}">${c.isActive ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ó–∞–≤–µ—Ä—à—ë–Ω'}</span>
        </div>
        <div class="credit-stats">
          <div>
            <div class="credit-stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
            <div class="credit-stat-value">${formatMoney(c.totalAmount)}</div>
          </div>
          <div>
            <div class="credit-stat-label">–û—Å—Ç–∞—Ç–æ–∫</div>
            <div class="credit-stat-value" style="color:${c.isActive?'var(--warning)':'var(--success)'}">${formatMoney(c.remainingAmount)}</div>
          </div>
          <div>
            <div class="credit-stat-label">–°—Ç–∞–≤–∫–∞</div>
            <div class="credit-stat-value">${c.interestRate}%</div>
          </div>
          <div>
            <div class="credit-stat-label">–ü–ª–∞—Ç—ë–∂/–º–µ—Å</div>
            <div class="credit-stat-value">${formatMoney(c.monthlyPayment)}</div>
          </div>
        </div>
        <div class="credit-progress">
          <div class="progress-bar-bg">
            <div class="progress-bar-fill ${barClass}" style="width:${percent}%"></div>
          </div>
          <div class="progress-text">
            <span>–ü–æ–≥–∞—à–µ–Ω–æ ${percent}%</span>
            <span>${formatMoney(paid)} –∏–∑ ${formatMoney(c.totalAmount)}</span>
          </div>
        </div>
      </div>`;
  }).join('');
}

function filterCredits(filter) {
  currentCreditFilter = filter;
  document.querySelectorAll('#credit-filter-tabs .filter-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderCreditsList();
}

// ============================
// ADD EXPENSE FORM
// ============================
function showAddExpenseForm() {
  const creditOptions = appData.credits.filter(c=>c.isActive).map(c => `<option value="${c.id}">${c.name} (${formatMoney(c.monthlyPayment)})</option>`).join('');

  showModal(`
    <div class="modal-content" style="max-width:440px;text-align:left;max-height:90vh;overflow-y:auto;">
      <h3 class="modal-title" style="text-align:center;">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h3>

      <div class="input-group">
        <label>–°—É–º–º–∞ *</label>
        <input type="number" id="exp-amount" placeholder="0.00" step="0.01" min="0.01">
      </div>

      <div class="input-group">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
        <select id="exp-category" onchange="onCategoryChange()">
          ${Object.keys(CATEGORIES).map(c => `<option value="${c}">${CATEGORIES[c].icon} ${c}</option>`).join('')}
        </select>
      </div>

      <div class="input-group hidden" id="exp-credit-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–µ–¥–∏—Ç</label>
        <select id="exp-credit">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
          ${creditOptions}
        </select>
      </div>

      <div class="input-group">
        <label>–ú–µ—Å—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="text" id="exp-place" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞">
      </div>

      <div class="input-group">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="exp-date" value="${new Date().toISOString().split('T')[0]}">
      </div>

      <div class="input-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="exp-comment" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `);
}

function onCategoryChange() {
  const cat = document.getElementById('exp-category').value;
  const creditGroup = document.getElementById('exp-credit-group');
  if (cat === '–ö—Ä–µ–¥–∏—Ç') {
    creditGroup.classList.remove('hidden');
    const creditSel = document.getElementById('exp-credit');
    if (creditSel.value) {
      const credit = appData.credits.find(c => c.id === creditSel.value);
      if (credit) document.getElementById('exp-amount').value = credit.monthlyPayment.toFixed(2);
    }
  } else {
    creditGroup.classList.add('hidden');
  }
}

function saveExpense() {
  const amount = parseFloat(document.getElementById('exp-amount').value);
  const category = document.getElementById('exp-category').value;
  const place = document.getElementById('exp-place').value.trim();
  const date = document.getElementById('exp-date').value;
  const comment = document.getElementById('exp-comment').value.trim();

  if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error'); return; }
  if (!date) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'error'); return; }

  const expense = { id: genId(), amount, category, place, date, comment };
  appData.expenses.push(expense);

  // If credit payment
  if (category === '–ö—Ä–µ–¥–∏—Ç') {
    const creditId = document.getElementById('exp-credit').value;
    if (creditId) {
      const credit = appData.credits.find(c => c.id === creditId);
      if (credit) {
        credit.remainingAmount = Math.max(0, credit.remainingAmount - amount);
        if (credit.remainingAmount <= 0) {
          credit.isActive = false;
          showToast('üéâ –ö—Ä–µ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω!', 'success');
        }
      }
    }
  }

  saveData();
  addLog(`–†–∞—Å—Ö–æ–¥: ${amount}‚ÇΩ, ${category}`);
  closeModal();
  showToast('–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
  updateUI();
}

// ============================
// ADD INCOME FORM
// ============================
function showAddIncomeForm() {
  showModal(`
    <div class="modal-content" style="max-width:400px;text-align:left;">
      <h3 class="modal-title" style="text-align:center;">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h3>

      <div class="input-group">
        <label>–°—É–º–º–∞ *</label>
        <input type="number" id="inc-amount" placeholder="0.00" step="0.01" min="0.01">
      </div>

      <div class="input-group">
        <label>–ò—Å—Ç–æ—á–Ω–∏–∫</label>
        <input type="text" id="inc-source" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞, —Ñ—Ä–∏–ª–∞–Ω—Å...">
      </div>

      <div class="input-group">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="inc-date" value="${new Date().toISOString().split('T')[0]}">
      </div>

      <div class="input-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="inc-comment" rows="2" placeholder=""></textarea>
      </div>

      <div class="btn-row">
        <button class="btn btn-success" onclick="saveIncome()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `);
}

function saveIncome() {
  const amount = parseFloat(document.getElementById('inc-amount').value);
  const source = document.getElementById('inc-source').value.trim();
  const date = document.getElementById('inc-date').value;
  const comment = document.getElementById('inc-comment').value.trim();

  if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error'); return; }

  appData.incomes.push({ id: genId(), amount, source, date, comment });
  saveData();
  addLog(`–î–æ—Ö–æ–¥: ${amount}‚ÇΩ, ${source}`);
  closeModal();
  showToast('–î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
  updateUI();
}

// ============================
// ADD CREDIT FORM
// ============================
function showAddCreditForm(editId) {
  const credit = editId ? appData.credits.find(c => c.id === editId) : null;

  showModal(`
    <div class="modal-content" style="max-width:440px;text-align:left;max-height:90vh;overflow-y:auto;">
      <h3 class="modal-title" style="text-align:center;">${credit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–µ–¥–∏—Ç' : '–î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç'}</h3>

      <div class="input-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ *</label>
        <input type="text" id="cr-name" placeholder="–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç" value="${credit?.name||''}">
      </div>

      <div class="input-group">
        <label>–û–±—â–∞—è —Å—É–º–º–∞ *</label>
        <input type="number" id="cr-total" placeholder="0.00" step="0.01" value="${credit?.totalAmount||''}" oninput="calcMonthly()">
      </div>

      <div class="input-group">
        <label>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (% –≥–æ–¥–æ–≤—ã—Ö) *</label>
        <input type="number" id="cr-rate" placeholder="12.5" step="0.01" value="${credit?.interestRate||''}" oninput="calcMonthly()">
      </div>

      <div class="input-group">
        <label>–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
        <input type="date" id="cr-start" value="${credit?.startDate || new Date().toISOString().split('T')[0]}">
      </div>

      <div class="input-group">
        <label>–°—Ä–æ–∫ (–º–µ—Å—è—Ü–µ–≤) *</label>
        <select id="cr-term" onchange="calcMonthly()">
          ${[6,12,18,24,36,48,60,84,120].map(m => `<option value="${m}" ${credit?.termMonths===m?'selected':''}>${m} –º–µ—Å.</option>`).join('')}
        </select>
      </div>

      <div class="input-group">
        <label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)</label>
        <input type="number" id="cr-monthly" placeholder="–ê–≤—Ç–æ" step="0.01" value="${credit?.monthlyPayment||''}" readonly style="opacity:0.7;">
      </div>

      ${credit ? `
      <div class="input-group">
        <label>–û—Å—Ç–∞–≤—à–∞—è—Å—è —Å—É–º–º–∞</label>
        <input type="number" id="cr-remaining" step="0.01" value="${credit.remainingAmount}">
      </div>` : ''}

      <div class="input-group">
        <label>–ë–∞–Ω–∫ / –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
        <input type="text" id="cr-bank" placeholder="–°–±–µ—Ä–±–∞–Ω–∫" value="${credit?.bank||''}">
      </div>

      <div class="input-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="cr-comment" rows="2">${credit?.comment||''}</textarea>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveCredit('${editId||''}')">${credit ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>

      ${credit ? `<button class="btn btn-danger" style="margin-top:12px;" onclick="deleteCredit('${editId}')">–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>` : ''}
    </div>
  `);

  if (!credit) setTimeout(calcMonthly, 100);
}

function calcMonthly() {
  const S = parseFloat(document.getElementById('cr-total')?.value);
  const rateYear = parseFloat(document.getElementById('cr-rate')?.value);
  const n = parseInt(document.getElementById('cr-term')?.value);
  const monthlyField = document.getElementById('cr-monthly');

  if (!S || !rateYear || !n || !monthlyField) return;

  const r = rateYear / 12 / 100;
  if (r === 0) {
    monthlyField.value = (S / n).toFixed(2);
    return;
  }
  const A = S * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
  monthlyField.value = A.toFixed(2);
}

function saveCredit(editId) {
  const name = document.getElementById('cr-name').value.trim();
  const totalAmount = parseFloat(document.getElementById('cr-total').value);
  const interestRate = parseFloat(document.getElementById('cr-rate').value);
  const startDate = document.getElementById('cr-start').value;
  const termMonths = parseInt(document.getElementById('cr-term').value);
  const monthlyPayment = parseFloat(document.getElementById('cr-monthly').value);
  const bank = document.getElementById('cr-bank').value.trim();
  const comment = document.getElementById('cr-comment').value.trim();

  if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error'); return; }
  if (!totalAmount || totalAmount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error'); return; }
  if (interestRate < 0) { showToast('–°—Ç–∞–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error'); return; }

  if (editId) {
    const credit = appData.credits.find(c => c.id === editId);
    if (credit) {
      const remField = document.getElementById('cr-remaining');
      credit.name = name;
      credit.totalAmount = totalAmount;
      credit.interestRate = interestRate;
      credit.startDate = startDate;
      credit.termMonths = termMonths;
      credit.monthlyPayment = monthlyPayment;
      credit.bank = bank;
      credit.comment = comment;
      if (remField) credit.remainingAmount = parseFloat(remField.value) || 0;
      if (credit.remainingAmount <= 0) credit.isActive = false;
    }
    addLog(`–ö—Ä–µ–¥–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω: ${name}`);
  } else {
    appData.credits.push({
      id: genId(), name, totalAmount, remainingAmount: totalAmount,
      interestRate, startDate, termMonths, monthlyPayment,
      bank, comment, isActive: true
    });
    addLog(`–ö—Ä–µ–¥–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω: ${name}, ${totalAmount}‚ÇΩ`);
  }

  saveData();
  closeModal();
  showToast(editId ? '–ö—Ä–µ–¥–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ö—Ä–µ–¥–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
  updateUI();
}

function deleteCredit(id) {
  showModal(`
    <div class="modal-content">
      <div class="modal-icon danger">üóëÔ∏è</div>
      <h3 class="modal-title">–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç?</h3>
      <p class="modal-text">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –∫—Ä–µ–¥–∏—Ç–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="confirmDeleteCredit('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `);
}

function confirmDeleteCredit(id) {
  appData.credits = appData.credits.filter(c => c.id !== id);
  saveData();
  addLog('–ö—Ä–µ–¥–∏—Ç —É–¥–∞–ª—ë–Ω');
  closeModal();
  showToast('–ö—Ä–µ–¥–∏—Ç —É–¥–∞–ª—ë–Ω', 'info');
  updateUI();
}

// ============================
// CREDIT DETAIL
// ============================
function showCreditDetail(id) {
  const c = appData.credits.find(cr => cr.id === id);
  if (!c) return;

  const schedule = generateSchedule(c);
  const paid = c.totalAmount - c.remainingAmount;
  const percent = c.totalAmount > 0 ? Math.round((paid/c.totalAmount)*100) : 0;

  showModal(`
    <div class="modal-content" style="max-width:460px;text-align:left;max-height:90vh;overflow-y:auto;">
      <h3 class="modal-title" style="text-align:center;">${c.name}</h3>
      ${c.bank ? `<p style="text-align:center;color:var(--text-muted);margin-bottom:16px;">${c.bank}</p>` : ''}

      <div class="credit-stats" style="margin-bottom:20px;">
        <div><div class="credit-stat-label">–°—É–º–º–∞</div><div class="credit-stat-value">${formatMoney(c.totalAmount)}</div></div>
        <div><div class="credit-stat-label">–û—Å—Ç–∞—Ç–æ–∫</div><div class="credit-stat-value" style="color:var(--warning)">${formatMoney(c.remainingAmount)}</div></div>
        <div><div class="credit-stat-label">–°—Ç–∞–≤–∫–∞</div><div class="credit-stat-value">${c.interestRate}%</div></div>
        <div><div class="credit-stat-label">–°—Ä–æ–∫</div><div class="credit-stat-value">${c.termMonths} –º–µ—Å.</div></div>
      </div>

      <div style="margin-bottom:20px;">
        <div class="progress-bar-bg" style="height:10px;">
          <div class="progress-bar-fill ${percent<=50?'green':percent<=90?'yellow':'red'}" style="width:${percent}%"></div>
        </div>
        <div class="progress-text"><span>–ü–æ–≥–∞—à–µ–Ω–æ ${percent}%</span></div>
      </div>

      <h4 style="font-family:var(--font-heading);font-size:15px;margin-bottom:12px;">üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h4>
      <div style="overflow-x:auto;">
        <table class="schedule-table">
          <thead>
            <tr><th>–ú–µ—Å.</th><th>–ü–ª–∞—Ç—ë–∂</th><th>–û—Å–Ω–æ–≤–Ω–æ–π</th><th>%</th><th>–û—Å—Ç–∞—Ç–æ–∫</th></tr>
          </thead>
          <tbody>
            ${schedule.slice(0,12).map(s => `
              <tr>
                <td>${s.month}</td>
                <td>${formatMoney(s.payment)}</td>
                <td>${formatMoney(s.principal)}</td>
                <td>${formatMoney(s.interest)}</td>
                <td>${formatMoney(s.balance)}</td>
              </tr>
            `).join('')}
            ${schedule.length > 12 ? `<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">... –µ—â—ë ${schedule.length-12} –º–µ—Å.</td></tr>` : ''}
          </tbody>
        </table>
      </div>

      <div class="btn-row" style="margin-top:20px;">
        <button class="btn btn-primary" onclick="closeModal();showAddCreditForm('${id}');">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  `);
}

function generateSchedule(credit) {
  const schedule = [];
  const r = credit.interestRate / 12 / 100;
  let balance = credit.totalAmount;
  const payment = credit.monthlyPayment;

  for (let i = 1; i <= credit.termMonths; i++) {
    const interest = balance * r;
    const principal = Math.min(payment - interest, balance);
    balance = Math.max(0, balance - principal);
    schedule.push({ month: i, payment: Math.min(payment, principal+interest), principal, interest, balance });
    if (balance <= 0) break;
  }
  return schedule;
}

// ============================
// TRANSACTION DETAIL
// ============================
function showTransactionDetail(id, type) {
  let item;
  if (type === 'expense') item = appData.expenses.find(e => e.id === id);
  else item = appData.incomes.find(i => i.id === id);
  if (!item) return;

  const isIncome = type === 'income';
  const cat = CATEGORIES[item.category] || CATEGORIES['–ü—Ä–æ—á–µ–µ'];

  showModal(`
    <div class="modal-content" style="text-align:left;">
      <h3 class="modal-title" style="text-align:center;">${isIncome ? (item.source||'–î–æ—Ö–æ–¥') : item.category}</h3>
      <div style="text-align:center;font-size:32px;font-weight:900;font-family:var(--font-heading);margin:16px 0;color:${isIncome?'var(--success)':'var(--danger)'};">
        ${isIncome?'+':'‚àí'}${formatMoney(item.amount)}
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-muted);">–î–∞—Ç–∞:</span><span>${formatDate(item.date)}</span></div>
        ${item.place ? `<div style="display:flex;justify-content:space-between;"><span style="color:var(--text-muted);">–ú–µ—Å—Ç–æ:</span><span>${item.place}</span></div>` : ''}
        ${item.comment ? `<div style="display:flex;justify-content:space-between;"><span style="color:var(--text-muted);">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span><span>${item.comment}</span></div>` : ''}
      </div>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="deleteTransaction('${id}','${type}')">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  `);
}

function deleteTransaction(id, type) {
  if (type === 'expense') appData.expenses = appData.expenses.filter(e => e.id !== id);
  else appData.incomes = appData.incomes.filter(i => i.id !== id);
  saveData();
  addLog(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å: ${type}`);
  closeModal();
  showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'info');
  updateUI();
}

// ============================
// SETTINGS UI
// ============================
function updateSettingsUI() {
  if (!appData.user) return;
  const avatar = document.getElementById('user-avatar');
  const nameEl = document.getElementById('user-display-name');
  const emailEl = document.getElementById('user-display-email');

  avatar.textContent = appData.user.name.charAt(0).toUpperCase();
  nameEl.textContent = appData.user.name;
  emailEl.textContent = appData.user.isGuest ? '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º' : appData.user.email;
  document.getElementById('notif-status').textContent = appData.settings.notifications ? '–í–∫–ª' : '–í—ã–∫–ª';
}

function toggleNotifications() {
  appData.settings.notifications = !appData.settings.notifications;
  saveData();
  showToast(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ${appData.settings.notifications ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`, 'info');
  updateSettingsUI();
}

// ============================
// EXPORT
// ============================
function exportCSV() {
  let csv = '–î–∞—Ç–∞,–¢–∏–ø,–°—É–º–º–∞,–ö–∞—Ç–µ–≥–æ—Ä–∏—è/–ò—Å—Ç–æ—á–Ω–∏–∫,–ú–µ—Å—Ç–æ,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n';
  appData.expenses.forEach(e => {
    csv += `${e.date},–†–∞—Å—Ö–æ–¥,${e.amount},${e.category},"${e.place||''}","${e.comment||''}"\n`;
  });
  appData.incomes.forEach(i => {
    csv += `${i.date},–î–æ—Ö–æ–¥,${i.amount},"${i.source||''}",,${i.comment||''}\n`;
  });

  // Credits section
  csv += '\n–ö—Ä–µ–¥–∏—Ç—ã\n–ù–∞–∑–≤–∞–Ω–∏–µ,–°—É–º–º–∞,–û—Å—Ç–∞—Ç–æ–∫,–°—Ç–∞–≤–∫–∞,–°—Ä–æ–∫,–ü–ª–∞—Ç—ë–∂,–ë–∞–Ω–∫,–°—Ç–∞—Ç—É—Å\n';
  appData.credits.forEach(c => {
    csv += `"${c.name}",${c.totalAmount},${c.remainingAmount},${c.interestRate},${c.termMonths},${c.monthlyPayment},"${c.bank||''}",${c.isActive?'–ê–∫—Ç–∏–≤–Ω—ã–π':'–ó–∞–≤–µ—Ä—à—ë–Ω'}\n`;
  });

  downloadFile(csv, 'spendly_export.csv', 'text/csv');
  addLog('–≠–∫—Å–ø–æ—Ä—Ç CSV');
  showToast('–§–∞–π–ª CSV —Å–∫–∞—á–∞–Ω', 'success');
}

function exportJSON() {
  const data = {
    exportDate: new Date().toISOString(),
    expenses: appData.expenses,
    incomes: appData.incomes,
    credits: appData.credits
  };
  downloadFile(JSON.stringify(data, null, 2), 'spendly_export.json', 'application/json');
  addLog('–≠–∫—Å–ø–æ—Ä—Ç JSON');
  showToast('–§–∞–π–ª JSON —Å–∫–∞—á–∞–Ω', 'success');
}

function exportLogs() {
  const text = logs.join('\n');
  downloadFile(text, 'spendly_logs.txt', 'text/plain');
  showToast('–õ–æ–≥–∏ —Å–∫–∞—á–∞–Ω—ã', 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// ============================
// IMPORT
// ============================
function triggerImport() {
  document.getElementById('import-file').click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  if (ext !== 'csv' && ext !== 'json') {
    showToast('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .csv –∏ .json —Ñ–∞–π–ª—ã', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      if (ext === 'json') {
        const data = JSON.parse(e.target.result);
        if (data.expenses) appData.expenses.push(...data.expenses);
        if (data.incomes) appData.incomes.push(...data.incomes);
        if (data.credits) appData.credits.push(...data.credits);
      } else {
        // Basic CSV import
        const lines = e.target.result.split('\n');
        lines.slice(1).forEach(line => {
          const cols = line.split(',');
          if (cols.length >= 4 && cols[1]) {
            const type = cols[1].trim();
            if (type === '–†–∞—Å—Ö–æ–¥') {
              appData.expenses.push({
                id: genId(), date: cols[0].trim(), amount: parseFloat(cols[2]),
                category: cols[3].replace(/"/g,'').trim(), place: (cols[4]||'').replace(/"/g,'').trim(),
                comment: (cols[5]||'').replace(/"/g,'').trim()
              });
            } else if (type === '–î–æ—Ö–æ–¥') {
              appData.incomes.push({
                id: genId(), date: cols[0].trim(), amount: parseFloat(cols[2]),
                source: cols[3].replace(/"/g,'').trim(), comment: (cols[5]||'').replace(/"/g,'').trim()
              });
            }
          }
        });
      }
      saveData();
      addLog(`–ò–º–ø–æ—Ä—Ç –∏–∑ ${file.name}`);
      showToast(`–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ ${file.name}`, 'success');
      updateUI();
    } catch(err) {
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞', 'error');
      console.error(err);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ============================
// LOGOUT
// ============================
function showLogoutConfirm() {
  showModal(`
    <div class="modal-content">
      <div class="modal-icon warning">‚ö†Ô∏è</div>
      <h3 class="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
      <p class="modal-text">–í—ã –≤—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞. –ü–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–∫–∞—á–∞—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.</p>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="doLogout()">–î–∞, –≤—ã–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="closeModal()">–ù–µ—Ç</button>
      </div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-secondary" onclick="closeModal();exportCSV();">üìÑ –°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã</button>
        <button class="btn btn-secondary" onclick="closeModal();exportLogs();">üìù –°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏</button>
      </div>
    </div>
  `);
}

function doLogout() {
  appData.user = null;
  saveData();
  addLog('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
  closeModal();
  document.getElementById('bottom-nav').classList.add('hidden');
  showScreen('auth-screen');
  showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
}

// ============================
// INIT
// ============================
loadData();
if (appData.user) {
  // Skip splash if already logged in
  document.getElementById('splash-screen').classList.add('hidden');
  enterApp();
}
</script>
</body>
</html>
