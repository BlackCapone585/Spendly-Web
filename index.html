<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spendly</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Unbounded -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(255, 255, 255, 0.03);
            --border-panel: rgba(255, 255, 255, 0.05);
            --accent-purple: #a855f7;
            --accent-cyan: #2dd4bf;
        }
        body {
            font-family: 'Unbounded', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            background-image: radial-gradient(circle at 50% 0%, #1a0b2e 0%, #050505 60%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }
        .text-gradient {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .bg-gradient-btn {
            background: linear-gradient(90deg, #8b5cf6, #14b8a6);
            transition: opacity 0.2s;
        }
        .bg-gradient-btn:active {
            opacity: 0.8;
        }
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-panel);
            border-radius: 1.25rem;
        }
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.875rem 1rem;
            color: white;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
            font-family: 'Unbounded', sans-serif;
        }
        .input-field:focus {
            border-color: var(--accent-purple);
        }
        .input-field option, .input-field optgroup {
            background: #111;
            color: white;
            font-family: sans-serif; /* Unbounded can be glitchy in native selects */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: rgba(255,255,255,0.1);
            border-radius: 999px;
            overflow: hidden;
            height: 0.5rem;
            margin-top: 0.5rem;
        }
        .progress-bar {
            height: 100%;
            border-radius: 999px;
            transition: width 0.3s ease;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex flex-col items-center justify-center">

<div id="app-container" class="relative w-full max-w-md h-full sm:h-[90vh] sm:rounded-[2rem] sm:border border-gray-800 bg-[#050505] overflow-hidden shadow-2xl flex flex-col">
    
    <!-- 1. Splash Screen -->
    <div id="screen-splash" class="app-screen absolute inset-0 z-10 flex flex-col items-center justify-center p-6 bg-[#050505]">
        <img src="images/logo_spedly_png.png" alt="Spendly Logo" class="h-24 mb-6 object-contain" onerror="this.outerHTML='<div class=\'w-24 h-24 bg-gradient-btn rounded-3xl flex items-center justify-center mb-6 shadow-lg shadow-purple-500/30\'><span class=\'text-5xl font-bold text-white\'>S</span></div>'">
        <h1 class="text-2xl font-bold mb-10 text-center tracking-tight">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Spendly!</h1>
        <button onclick="navigate('screen-login')" class="bg-gradient-btn px-8 py-4 rounded-2xl font-semibold w-full text-lg shadow-lg shadow-teal-500/20">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <!-- 2. Login Screen -->
    <div id="screen-login" class="app-screen hidden absolute inset-0 z-10 flex flex-col items-center justify-center p-6 bg-[#050505] overflow-y-auto no-scrollbar">
        <img src="images/vhod.png" alt="–í—Ö–æ–¥" class="h-16 mb-6 object-contain" onerror="this.style.display='none'">
        <div class="w-16 h-16 bg-gradient-btn rounded-2xl flex items-center justify-center mb-6 shadow-lg">
            <span class="text-3xl font-bold">S</span>
        </div>
        <h2 class="text-2xl font-bold mb-8 tracking-tight">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        
        <form class="w-full space-y-4" onsubmit="event.preventDefault();">
            <input type="text" id="auth-email" placeholder="–ü–æ—á—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" class="input-field" required>
            <input type="text" id="auth-name" placeholder="–ò–º—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –º–∏–Ω 3 —Å–∏–º–≤.)" class="input-field min-length-3">
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field" required minlength="6">
            
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="handleAuth('login')" class="flex-1 bg-gradient-btn py-4 rounded-2xl font-semibold shadow-lg shadow-purple-500/20">–í–æ–π—Ç–∏</button>
                <button type="button" onclick="handleAuth('register')" class="flex-1 border border-teal-500 text-teal-400 py-4 rounded-2xl font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <button type="button" onclick="navigate('screen-guest-warning')" class="w-full bg-[#1a1a1a] text-gray-400 py-4 rounded-2xl mt-4 font-semibold hover:text-white transition-colors">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
        </form>
    </div>

    <!-- 3. Guest Warning Screen -->
    <div id="screen-guest-warning" class="app-screen hidden absolute inset-0 z-10 flex flex-col items-center justify-center p-6 bg-[#050505] text-center">
        <img src="images/vnimanie.png" alt="–í–Ω–∏–º–∞–Ω–∏–µ" class="h-24 mb-6 object-contain" onerror="this.outerHTML='<div class=\'text-yellow-500 mb-6\'><svg class=\'w-24 h-24 mx-auto\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\'></path></svg></div>'">
        <h2 class="text-2xl font-bold mb-4 text-gradient">–í–Ω–∏–º–∞–Ω–∏–µ!</h2>
        <p class="mb-10 text-gray-400 leading-relaxed text-sm">–ï—Å–ª–∏ –≤—ã –Ω–µ –≤–æ–π–¥—ë—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —Ç–æ –¥–∞–ª—å—à–µ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç—Ä–∞—Ç—ã –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–≤–∞–π—Å.</p>
        <div class="flex flex-col gap-3 w-full">
            <button onclick="loginGuest()" class="w-full bg-gradient-btn py-4 rounded-2xl font-semibold text-lg shadow-lg">–°–æ–≥–ª–∞—à–∞—é—Å—å</button>
            <button onclick="navigate('screen-login')" class="w-full bg-[#1a1a1a] py-4 rounded-2xl font-semibold text-gray-300">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- 4. Main Application Interface -->
    <div id="screen-main" class="app-screen hidden flex-1 flex flex-col h-full w-full relative">
        <!-- Main Header -->
        <header class="p-5 flex justify-between items-center z-10">
            <div>
                <h2 id="user-greeting" class="text-xl font-bold">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</h2>
                <p class="text-xs text-gray-400 mt-1">Spendly Tracker</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-gradient-btn flex items-center justify-center font-bold text-lg shadow-lg" id="user-avatar-letter">–ì</div>
        </header>

        <!-- Viewport Container -->
        <main class="flex-1 overflow-y-auto px-4 pb-24 no-scrollbar relative z-0">
            
            <!-- VIEW: HOME -->
            <div id="view-home" class="app-view space-y-6 animate-fade-in">
                <div class="glass-panel p-6 flex flex-col items-center relative overflow-hidden">
                    <!-- decorative blur -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-600 rounded-full blur-[3rem] opacity-20"></div>
                    <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-teal-600 rounded-full blur-[3rem] opacity-20"></div>
                    
                    <h3 class="text-sm text-gray-400 mb-1 z-10">–û–±—â–∏–µ —Ç—Ä–∞—Ç—ã</h3>
                    <div class="text-3xl font-bold mb-6 z-10 tracking-tight" id="home-total-expenses">0 ‚ÇΩ</div>
                    
                    <div class="w-48 h-48 relative z-10 mb-2">
                        <canvas id="home-chart"></canvas>
                    </div>
                </div>
                
                <button onclick="openModal('modal-add-expense')" class="bg-gradient-btn w-full py-4 rounded-2xl font-semibold flex items-center justify-center gap-2 shadow-lg shadow-purple-500/20 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É
                </button>

                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-lg">–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–∞—Ç—ã</h3>
                        <button onclick="switchView('view-stats')" class="text-xs text-teal-400">–í—Å–µ</button>
                    </div>
                    <div id="home-recent-list" class="space-y-3">
                        <!-- populated by JS -->
                        <div class="text-center text-gray-500 text-sm py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INCOMES -->
            <div id="view-incomes" class="app-view hidden space-y-6 animate-fade-in">
                <div class="glass-panel p-6 text-center">
                    <h3 class="text-sm text-gray-400 mb-1">–û—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤</h3>
                    <div class="text-4xl font-bold text-gradient mb-4" id="incomes-balance">0 ‚ÇΩ</div>
                    <div class="flex justify-between text-sm mt-4 bg-black/30 p-3 rounded-xl">
                        <div class="flex flex-col items-center w-1/2 border-r border-gray-700">
                            <span class="text-gray-400 text-xs mb-1">–î–æ—Ö–æ–¥—ã</span>
                            <span class="text-green-400 font-bold" id="incomes-total-in">0 ‚ÇΩ</span>
                        </div>
                        <div class="flex flex-col items-center w-1/2">
                            <span class="text-gray-400 text-xs mb-1">–¢—Ä–∞—Ç—ã</span>
                            <span class="text-red-400 font-bold" id="incomes-total-out">0 ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
                
                <button onclick="openModal('modal-add-income')" class="bg-gradient-btn w-full py-4 rounded-2xl font-semibold flex items-center justify-center gap-2 shadow-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥
                </button>

                <div>
                    <h3 class="font-bold mb-4 text-lg">–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤</h3>
                    <div id="incomes-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- VIEW: STATS -->
            <div id="view-stats" class="app-view hidden space-y-6 animate-fade-in">
                <h2 class="text-2xl font-bold">–û–±—â–∏–µ —Ç—Ä–∞—Ç—ã</h2>
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <button class="px-5 py-2 rounded-xl glass-panel text-sm font-semibold bg-white/10 text-white border-teal-500">–í—Å–µ</button>
                    <button class="px-5 py-2 rounded-xl glass-panel text-sm text-gray-400">–ù–µ–¥–µ–ª—è</button>
                    <button class="px-5 py-2 rounded-xl glass-panel text-sm text-gray-400">–ú–µ—Å—è—Ü</button>
                    <input type="date" class="px-3 py-2 rounded-xl glass-panel text-sm bg-transparent outline-none text-gray-400">
                </div>
                
                <div class="glass-panel p-4 h-64">
                    <canvas id="stats-chart"></canvas>
                </div>

                <div>
                    <h3 class="font-bold mb-4 text-lg">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—Ä–∞—Ç</h3>
                    <div id="stats-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- VIEW: CREDITS -->
            <div id="view-credits" class="app-view hidden space-y-6 animate-fade-in">
                <h2 class="text-2xl font-bold text-center">–ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã</h2>
                <button onclick="openModal('modal-add-credit')" class="bg-gradient-btn w-full py-4 rounded-2xl font-semibold flex items-center justify-center gap-2 shadow-lg shadow-purple-500/20">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç
                </button>
                
                <div>
                    <h3 class="font-bold mb-4 text-lg text-teal-400">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã</h3>
                    <div id="credits-active-list" class="space-y-4"></div>
                </div>

                <details class="glass-panel group">
                    <summary class="p-4 font-bold cursor-pointer outline-none flex justify-between items-center text-gray-400">
                        –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-4 pt-0 border-t border-gray-800 mt-2" id="credits-completed-list"></div>
                </details>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="app-view hidden space-y-6 animate-fade-in">
                <div class="glass-panel p-8 text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-purple-600 rounded-full blur-[4rem] opacity-20"></div>
                    <div class="w-24 h-24 rounded-full bg-gradient-btn mx-auto flex items-center justify-center text-4xl font-bold mb-4 shadow-lg shadow-purple-500/30" id="settings-avatar">–ì</div>
                    <h2 class="text-2xl font-bold mb-1" id="settings-name">–ì–æ—Å—Ç—å</h2>
                    <p class="text-teal-400 text-sm font-mono bg-black/30 inline-block px-3 py-1 rounded-lg" id="settings-id">ID: guest</p>
                </div>

                <div class="space-y-3">
                    <button onclick="exportData('csv')" class="w-full glass-panel p-4 text-left font-semibold flex items-center justify-between hover:bg-white/5 transition-colors">
                        –°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã (CSV) <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button onclick="exportData('json')" class="w-full glass-panel p-4 text-left font-semibold flex items-center justify-between hover:bg-white/5 transition-colors">
                        –°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã (JSON) <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button onclick="exportLogs()" class="w-full glass-panel p-4 text-left font-semibold flex items-center justify-between hover:bg-white/5 transition-colors">
                        –°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏ <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </button>
                    <label class="w-full glass-panel p-4 text-left font-semibold flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors">
                        –í—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—ã (–ò–º–ø–æ—Ä—Ç)
                        <input type="file" id="import-file" class="hidden" accept=".json,.csv" onchange="importData(event)">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </label>
                    <button onclick="openModal('modal-logout')" class="w-full p-4 text-center font-bold text-red-400 glass-panel border border-red-500/30 mt-6 hover:bg-red-500/10 transition-colors">
                        –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="absolute bottom-0 w-full glass-panel rounded-b-none border-b-0 border-x-0 flex justify-around p-2 pt-3 pb-6 z-20 bg-[#0a0a0a]/90 backdrop-blur-xl">
            <button onclick="switchView('view-home')" id="nav-view-home" class="nav-btn flex flex-col items-center text-purple-400 w-16 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-[10px] font-medium">–ì–ª–∞–≤–Ω–∞—è</span>
            </button>
            <button onclick="switchView('view-incomes')" id="nav-view-incomes" class="nav-btn flex flex-col items-center text-gray-500 w-16 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-[10px] font-medium">–î–æ—Ö–æ–¥—ã</span>
            </button>
            <button onclick="switchView('view-stats')" id="nav-view-stats" class="nav-btn flex flex-col items-center text-gray-500 w-16 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <span class="text-[10px] font-medium">–¢—Ä–∞—Ç—ã</span>
            </button>
            <button onclick="switchView('view-credits')" id="nav-view-credits" class="nav-btn flex flex-col items-center text-gray-500 w-16 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                <span class="text-[10px] font-medium">–ö—Ä–µ–¥–∏—Ç—ã</span>
            </button>
            <button onclick="switchView('view-settings')" id="nav-view-settings" class="nav-btn flex flex-col items-center text-gray-500 w-16 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-[10px] font-medium">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <!-- Add Expense -->
    <div id="modal-add-expense" class="hidden absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full sm:max-w-md p-6 rounded-b-none sm:rounded-2xl flex flex-col gap-4 animate-slide-up sm:animate-fade-in bg-[#111]">
            <h3 class="text-xl font-bold mb-2">–ù–æ–≤–∞—è —Ç—Ä–∞—Ç–∞</h3>
            <input type="number" id="exp-amount" placeholder="–°—É–º–º–∞ (‚ÇΩ)" class="input-field text-xl" step="0.01" inputmode="decimal">
            <select id="exp-category" class="input-field" onchange="toggleCreditSelect()">
                <option value="–µ–¥–∞">–ï–¥–∞</option>
                <option value="—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                <option value="–∂–∏–ª—å—ë">–ñ–∏–ª—å—ë</option>
                <option value="—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                <option value="–ø—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
                <option value="–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É" class="text-teal-400 font-bold">–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É</option>
            </select>
            <select id="exp-credit-id" class="input-field hidden bg-teal-900/20 border-teal-500/50 text-teal-300">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–µ–¥–∏—Ç...</option>
            </select>
            <input type="text" id="exp-place" placeholder="–ú–µ—Å—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="input-field">
            <label class="flex items-center gap-3 text-sm text-gray-400 cursor-pointer p-1">
                <input type="checkbox" id="exp-location" class="w-5 h-5 rounded bg-[#1a1a1a] border-gray-600 text-purple-500 focus:ring-purple-500/50 accent-purple-500">
                –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            </label>
            <textarea id="exp-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="input-field resize-none h-20"></textarea>
            
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('modal-add-expense')" class="flex-1 bg-[#222] py-4 rounded-xl font-semibold">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveExpense()" class="flex-[2] bg-gradient-btn py-4 rounded-xl font-semibold text-lg shadow-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Add Income -->
    <div id="modal-add-income" class="hidden absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full sm:max-w-md p-6 rounded-b-none sm:rounded-2xl flex flex-col gap-4 animate-slide-up sm:animate-fade-in bg-[#111]">
            <h3 class="text-xl font-bold mb-2 text-green-400">–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥</h3>
            <input type="number" id="inc-amount" placeholder="–°—É–º–º–∞ (‚ÇΩ)" class="input-field text-xl border-green-500/50 focus:border-green-500" step="0.01" inputmode="decimal">
            <input type="text" id="inc-source" placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫ (–ó–∞—Ä–ø–ª–∞—Ç–∞, –ø–µ—Ä–µ–≤–æ–¥...)" class="input-field">
            <textarea id="inc-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="input-field resize-none h-20"></textarea>
            
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('modal-add-income')" class="flex-1 bg-[#222] py-4 rounded-xl font-semibold">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveIncome()" class="flex-[2] bg-green-600 hover:bg-green-500 py-4 rounded-xl font-semibold text-lg shadow-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Add Credit -->
    <div id="modal-add-credit" class="hidden absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full sm:max-w-md p-6 rounded-b-none sm:rounded-2xl flex flex-col gap-3 animate-slide-up sm:animate-fade-in bg-[#111] max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-2 text-teal-400">–û—Ñ–æ—Ä–º–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</h3>
            <input type="text" id="cred-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç)" class="input-field">
            <input type="number" id="cred-total" placeholder="–û–±—â–∞—è —Å—É–º–º–∞ (‚ÇΩ)" class="input-field" step="0.01">
            <div class="flex gap-3">
                <input type="number" id="cred-rate" placeholder="–°—Ç–∞–≤–∫–∞ % –≥–æ–¥–æ–≤—ã—Ö" class="input-field flex-1" step="0.1">
                <input type="number" id="cred-term" placeholder="–°—Ä–æ–∫ (–º–µ—Å)" class="input-field flex-1">
            </div>
            <input type="date" id="cred-date" class="input-field text-gray-400" placeholder="–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
            <input type="text" id="cred-bank" placeholder="–ë–∞–Ω–∫ / –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è" class="input-field">
            <textarea id="cred-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="input-field resize-none h-16"></textarea>
            
            <div class="flex gap-3 mt-4 pt-2 border-t border-gray-800">
                <button onclick="closeModal('modal-add-credit')" class="flex-1 bg-[#222] py-4 rounded-xl font-semibold">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveCredit()" class="flex-[2] bg-teal-600 hover:bg-teal-500 py-4 rounded-xl font-semibold text-lg shadow-lg">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirm -->
    <div id="modal-logout" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-3xl flex flex-col items-center text-center animate-fade-in bg-[#111]">
            <img src="images/vnimanie.png" alt="–í–Ω–∏–º–∞–Ω–∏–µ" class="h-16 mb-4 object-contain" onerror="this.outerHTML='<div class=\'text-red-500 mb-4\'><svg class=\'w-16 h-16\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\'></path></svg></div>'">
            <h3 class="text-xl font-bold mb-2">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
            <p class="text-gray-400 mb-6 text-sm">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
            <div class="w-full space-y-3 mb-6">
                <button onclick="exportLogs()" class="w-full bg-[#1a1a1a] py-3 rounded-xl text-sm font-semibold text-gray-300">–°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏</button>
                <button onclick="exportData('csv')" class="w-full bg-[#1a1a1a] py-3 rounded-xl text-sm font-semibold text-gray-300">–°–∫–∞—á–∞—Ç—å —Ç—Ä–∞—Ç—ã</button>
            </div>
            <div class="flex gap-3 w-full">
                <button onclick="closeModal('modal-logout')" class="flex-1 border border-gray-600 py-3 rounded-xl font-semibold">–ù–µ—Ç</button>
                <button onclick="executeLogout()" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-semibold shadow-lg">–î–∞, –≤—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- STATE MANAGEMENT ---
    let appData = {
        user: null, // { id: string, name: string, isGuest: boolean }
        transactions: [], // { id, amount, category, date, place, comment, isIncome, creditId }
        credits: [] // { id, name, totalAmount, remainingAmount, interestRate, startDate, termMonths, monthlyPayment, bank, comment, isActive }
    };

    let charts = {
        home: null,
        stats: null
    };

    // --- UTILS ---
    const generateId = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
    
    const formatMoney = (amount) => {
        return parseFloat(amount).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ‚ÇΩ';
    };

    const formatDate = (dateString) => {
        const d = new Date(dateString);
        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    const saveLocally = () => {
        localStorage.setItem('spendly_data', JSON.stringify(appData));
    };

    const loadLocally = () => {
        const data = localStorage.getItem('spendly_data');
        if (data) {
            try {
                appData = JSON.parse(data);
                if(!appData.transactions) appData.transactions = [];
                if(!appData.credits) appData.credits = [];
            } catch(e) { console.error("Error loading data", e); }
        }
    };

    // --- NAVIGATION ---
    function navigate(screenId) {
        document.querySelectorAll('.app-screen').forEach(el => el.classList.add('hidden'));
        const screen = document.getElementById(screenId);
        if(screen) {
            screen.classList.remove('hidden');
            if(screenId === 'screen-main') {
                initMainInterface();
            }
        }
    }

    function switchView(viewId) {
        document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        
        // Update Bottom Nav Styling
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-purple-400');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.getElementById(`nav-${viewId}`);
        if(activeBtn) {
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('text-purple-400');
        }

        // Render specific view data
        if(viewId === 'view-home') renderHome();
        if(viewId === 'view-incomes') renderIncomes();
        if(viewId === 'view-stats') renderStats();
        if(viewId === 'view-credits') renderCredits();
        if(viewId === 'view-settings') renderSettings();
    }

    function openModal(modalId) {
        if(modalId === 'modal-add-expense') toggleCreditSelect();
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // --- AUTHENTICATION ---
    function initApp() {
        loadLocally();
        setTimeout(() => {
            if (appData.user) {
                navigate('screen-main');
            } else {
                navigate('screen-login');
            }
        }, 2000); // 2 seconds splash screen
    }

    function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-password').value;
        const name = document.getElementById('auth-name').value || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        
        if(!email || pass.length < 6) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª—å –º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤).");

        // Mock Auth
        appData.user = {
            id: 'usr_' + generateId(),
            name: type === 'register' ? name : (email.split('@')[0] || 'User'),
            isGuest: false
        };
        saveLocally();
        navigate('screen-main');
    }

    function loginGuest() {
        appData.user = {
            id: 'guest_' + generateId(),
            name: '–ì–æ—Å—Ç—å',
            isGuest: true
        };
        saveLocally();
        navigate('screen-main');
    }

    function executeLogout() {
        appData.user = null;
        // Keep data or clear? For guest, we usually keep in local storage until cleared.
        // We will just remove user to show login screen.
        saveLocally();
        closeModal('modal-logout');
        navigate('screen-login');
        document.querySelectorAll('input, textarea').forEach(el => el.value = '');
    }

    function initMainInterface() {
        if(appData.user) {
            document.getElementById('user-greeting').innerText = `–ü—Ä–∏–≤–µ—Ç, ${appData.user.name}!`;
            document.getElementById('user-avatar-letter').innerText = appData.user.name.charAt(0).toUpperCase();
        }
        switchView('view-home');
    }

    // --- RENDERERS ---

    function getExpenses() { return appData.transactions.filter(t => !t.isIncome); }
    function getIncomes() { return appData.transactions.filter(t => t.isIncome); }

    function renderHome() {
        const expenses = getExpenses();
        const totalExp = expenses.reduce((sum, t) => sum + t.amount, 0);
        document.getElementById('home-total-expenses').innerText = formatMoney(totalExp);
        
        // Recent 5
        const recent = [...appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
        const list = document.getElementById('home-recent-list');
        if(recent.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-500 py-4 glass-panel">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
        } else {
            list.innerHTML = recent.map(t => `
                <div class="glass-panel p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${t.isIncome ? 'bg-green-500/20 text-green-400' : 'bg-purple-500/20 text-purple-400'} flex items-center justify-center">
                            ${t.isIncome ? '+' : '-'}
                        </div>
                        <div>
                            <div class="font-bold text-sm">${t.category}</div>
                            <div class="text-xs text-gray-400">${formatDate(t.date)}</div>
                        </div>
                    </div>
                    <div class="${t.isIncome ? 'text-green-400' : 'text-white'} font-bold">
                        ${t.isIncome ? '+' : '-'}${formatMoney(t.amount)}
                    </div>
                </div>
            `).join('');
        }

        // Chart
        const ctx = document.getElementById('home-chart');
        if(charts.home) charts.home.destroy();
        
        if(expenses.length === 0) {
            charts.home = new Chart(ctx, { type: 'doughnut', data: { labels: ['–ü—É—Å—Ç–æ'], datasets: [{ data: [1], backgroundColor: ['#1a1a1a'], borderWidth: 0 }] }, options: { cutout: '80%', plugins:{tooltip:{enabled:false}, legend:{display:false}} } });
            return;
        }

        const categories = {};
        expenses.forEach(e => { categories[e.category] = (categories[e.category]||0) + e.amount; });
        
        Chart.defaults.color = '#fff';
        Chart.defaults.font.family = 'Unbounded';
        
        charts.home = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categories),
                datasets: [{
                    data: Object.values(categories),
                    backgroundColor: ['#a855f7', '#2dd4bf', '#ec4899', '#f59e0b', '#3b82f6', '#14b8a6', '#8b5cf6'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                cutout: '75%',
                plugins: { 
                    legend: { display: false } 
                } 
            }
        });
    }

    function renderIncomes() {
        const incomes = getIncomes();
        const expenses = getExpenses();
        const totalIn = incomes.reduce((sum, t) => sum + t.amount, 0);
        const totalOut = expenses.reduce((sum, t) => sum + t.amount, 0);
        const balance = totalIn - totalOut;

        document.getElementById('incomes-balance').innerText = formatMoney(balance);
        document.getElementById('incomes-total-in').innerText = formatMoney(totalIn);
        document.getElementById('incomes-total-out').innerText = formatMoney(totalOut);

        const list = document.getElementById('incomes-list');
        if(incomes.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-500 py-4 glass-panel">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤</div>`;
        } else {
            list.innerHTML = [...incomes].sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
                <div class="glass-panel p-4 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-sm">${t.category}</div>
                        <div class="text-xs text-gray-400">${formatDate(t.date)} ${t.comment ? '‚Ä¢ '+t.comment : ''}</div>
                    </div>
                    <div class="text-green-400 font-bold">+${formatMoney(t.amount)}</div>
                </div>
            `).join('');
        }
    }

    function renderStats() {
        const expenses = getExpenses();
        const list = document.getElementById('stats-list');
        
        if(expenses.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-500 py-4 glass-panel">–ù–µ—Ç —Ç—Ä–∞—Ç</div>`;
        } else {
            list.innerHTML = [...expenses].sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
                <div class="glass-panel p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-sm text-purple-300">${t.category}</div>
                            <div class="text-xs text-gray-400">${formatDate(t.date)}</div>
                        </div>
                        <div class="font-bold text-white">-${formatMoney(t.amount)}</div>
                    </div>
                    ${(t.place || t.comment) ? `<div class="text-xs text-gray-400 mt-1 pt-2 border-t border-gray-800">${t.place ? 'üìç '+t.place : ''} ${t.comment}</div>` : ''}
                </div>
            `).join('');
        }

        // Stats Chart (Bar)
        const ctx = document.getElementById('stats-chart');
        if(charts.stats) charts.stats.destroy();
        
        if(expenses.length === 0) return;

        // Group by category for simplicity here
        const categories = {};
        expenses.forEach(e => { categories[e.category] = (categories[e.category]||0) + e.amount; });

        charts.stats = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(categories),
                datasets: [{
                    label: '–¢—Ä–∞—Ç—ã',
                    data: Object.values(categories),
                    backgroundColor: '#a855f7',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
                    x: { grid: { display: false }, ticks: { color: '#888' } }
                }
            }
        });
    }

    function renderCredits() {
        const activeList = document.getElementById('credits-active-list');
        const completedList = document.getElementById('credits-completed-list');
        
        const active = appData.credits.filter(c => c.isActive);
        const completed = appData.credits.filter(c => !c.isActive);

        const renderCard = (c) => {
            const progress = ((c.totalAmount - c.remainingAmount) / c.totalAmount) * 100;
            let pColor = 'bg-green-500'; // Actually requirement says: green 0-50, yellow 51-90, red 91-100.
            // This usually applies to DEBT remaining, but prompt says "–ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–≥–∞—à–µ–Ω–∏—è". Let's assume debt remaining logic:
            if(progress > 90) pColor = 'bg-green-500'; // almost done
            else if(progress > 50) pColor = 'bg-yellow-500';
            else pColor = 'bg-red-500'; // Just finished or early
            // Wait, prompt exact wording: "–∑–µ–ª—ë–Ω—ã–π 0‚Äì50 %, –∂—ë–ª—Ç—ã–π 51‚Äì90 %, –∫—Ä–∞—Å–Ω—ã–π 91‚Äì100 %". I'll just follow it strictly using progress value directly.
            
            let strictlyColor = 'bg-green-500';
            if(progress >= 51 && progress <= 90) strictlyColor = 'bg-yellow-500';
            if(progress > 90) strictlyColor = 'bg-red-500';

            return `
                <div class="glass-panel p-5 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3">
                        ${c.isActive ? '<span class="flex h-3 w-3 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-teal-500"></span></span>' : '<span class="text-xs text-gray-500 font-bold">–ó–ê–í–ï–†–®–ï–ù</span>'}
                    </div>
                    <h4 class="font-bold text-lg text-teal-300 mb-1">${c.name}</h4>
                    <p class="text-xs text-gray-400 mb-4">${c.bank} ‚Ä¢ ${c.interestRate}% –≥–æ–¥–æ–≤—ã—Ö</p>
                    
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-400">–û—Å—Ç–∞—Ç–æ–∫:</span>
                        <span class="font-bold">${formatMoney(c.remainingAmount)}</span>
                    </div>
                    <div class="flex justify-between text-sm mb-3">
                        <span class="text-gray-400">–ü–ª–∞—Ç—ë–∂:</span>
                        <span class="font-bold text-white">${formatMoney(c.monthlyPayment)} / –º–µ—Å</span>
                    </div>

                    <div class="mt-4">
                        <div class="flex justify-between text-xs mb-1">
                            <span>–ü–æ–≥–∞—à–µ–Ω–æ: ${progress.toFixed(1)}%</span>
                            <span>–ò–∑ ${formatMoney(c.totalAmount)}</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar ${strictlyColor}" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    ${c.isActive ? `
                    <div class="mt-4 pt-3 border-t border-gray-800 flex justify-end">
                        <button onclick="deleteCredit('${c.id}')" class="text-xs text-red-400 hover:text-red-300 transition-colors">–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
                    </div>` : ''}
                </div>
            `;
        };

        if(active.length === 0) activeList.innerHTML = `<div class="text-center text-gray-500 py-6 glass-panel border-dashed">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</div>`;
        else activeList.innerHTML = active.map(renderCard).join('');

        if(completed.length === 0) completedList.innerHTML = `<div class="text-center text-gray-600 py-4">–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</div>`;
        else completedList.innerHTML = completed.map(renderCard).join('');
    }

    function renderSettings() {
        if(appData.user) {
            document.getElementById('settings-name').innerText = appData.user.name;
            document.getElementById('settings-id').innerText = `ID: ${appData.user.id}`;
            document.getElementById('settings-avatar').innerText = appData.user.name.charAt(0).toUpperCase();
        }
    }

    // --- LOGIC: ADDING DATA ---
    function toggleCreditSelect() {
        const cat = document.getElementById('exp-category').value;
        const credSel = document.getElementById('exp-credit-id');
        if(cat === '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É') {
            credSel.classList.remove('hidden');
            const activeCredits = appData.credits.filter(c => c.isActive);
            if(activeCredits.length === 0) {
                credSel.innerHTML = `<option value="">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</option>`;
            } else {
                credSel.innerHTML = activeCredits.map(c => `<option value="${c.id}">${c.name} (–û—Å—Ç–∞—Ç–æ–∫: ${formatMoney(c.remainingAmount)})</option>`).join('');
            }
        } else {
            credSel.classList.add('hidden');
            credSel.value = '';
        }
    }

    function saveExpense() {
        const amount = parseFloat(document.getElementById('exp-amount').value);
        const category = document.getElementById('exp-category').value;
        const place = document.getElementById('exp-place').value;
        const comment = document.getElementById('exp-comment').value;
        const creditId = document.getElementById('exp-credit-id').value;

        if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
        if(category === '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É' && !creditId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–µ–¥–∏—Ç –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞");

        const tx = {
            id: generateId(),
            amount, category, date: new Date().toISOString(),
            place, comment, isIncome: false, creditId: creditId || null
        };

        appData.transactions.push(tx);

        if(category === '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É' && creditId) {
            const credit = appData.credits.find(c => c.id === creditId);
            if(credit) {
                credit.remainingAmount -= amount;
                if(credit.remainingAmount <= 0) {
                    credit.remainingAmount = 0;
                    credit.isActive = false;
                    alert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ö—Ä–µ–¥–∏—Ç "${credit.name}" –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω!`);
                }
            }
        }

        saveLocally();
        closeModal('modal-add-expense');
        
        // Reset form
        document.getElementById('exp-amount').value = '';
        document.getElementById('exp-place').value = '';
        document.getElementById('exp-comment').value = '';
        
        renderHome();
        renderStats();
        if(category === '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É') renderCredits();
    }

    function saveIncome() {
        const amount = parseFloat(document.getElementById('inc-amount').value);
        const source = document.getElementById('inc-source').value;
        const comment = document.getElementById('inc-comment').value;

        if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");

        const tx = {
            id: generateId(),
            amount, category: source || '–î–æ—Ö–æ–¥', date: new Date().toISOString(),
            place: '', comment, isIncome: true, creditId: null
        };

        appData.transactions.push(tx);
        saveLocally();
        closeModal('modal-add-income');
        
        document.getElementById('inc-amount').value = '';
        document.getElementById('inc-source').value = '';
        document.getElementById('inc-comment').value = '';
        
        renderIncomes();
    }

    function saveCredit() {
        const name = document.getElementById('cred-name').value;
        const totalAmount = parseFloat(document.getElementById('cred-total').value);
        const rate = parseFloat(document.getElementById('cred-rate').value);
        const term = parseInt(document.getElementById('cred-term').value);
        const date = document.getElementById('cred-date').value || new Date().toISOString().split('T')[0];
        const bank = document.getElementById('cred-bank').value;
        const comment = document.getElementById('cred-comment').value;

        if(!name || !totalAmount || isNaN(rate) || !term) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");

        // Annuity calculation
        const r = rate / 12 / 100;
        let monthlyPayment = 0;
        if(r === 0) {
            monthlyPayment = totalAmount / term;
        } else {
            const factor = Math.pow(1 + r, term);
            monthlyPayment = totalAmount * (r * factor) / (factor - 1);
        }

        const credit = {
            id: generateId(),
            name, totalAmount, remainingAmount: totalAmount,
            interestRate: rate, startDate: date, termMonths: term,
            monthlyPayment, bank, comment, isActive: true
        };

        appData.credits.push(credit);
        saveLocally();
        closeModal('modal-add-credit');
        
        // reset form
        ['cred-name','cred-total','cred-rate','cred-term','cred-date','cred-bank','cred-comment'].forEach(id => document.getElementById(id).value = '');
        
        renderCredits();
    }

    function deleteCredit(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç? –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è.")) {
            appData.credits = appData.credits.filter(c => c.id !== id);
            saveLocally();
            renderCredits();
        }
    }

    // --- EXPORT & IMPORT ---
    function exportLogs() {
        const content = "SPENDLY LOGS\n" + new Date().toString() + "\n" + JSON.stringify(appData, null, 2);
        downloadFile('spendly_logs.txt', content, 'text/plain');
    }

    function exportData(format) {
        if(format === 'json') {
            downloadFile('spendly_data.json', JSON.stringify(appData, null, 2), 'application/json');
        } else if(format === 'csv') {
            let csv = "–î–∞—Ç–∞,–¢–∏–ø,–°—É–º–º–∞,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–ú–µ—Å—Ç–æ,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            appData.transactions.forEach(t => {
                csv += `${new Date(t.date).toISOString().split('T')[0]},${t.isIncome?'–î–æ—Ö–æ–¥':'–¢—Ä–∞—Ç–∞'},${t.amount},"${t.category}","${t.place||''}","${t.comment||''}"\n`;
            });
            downloadFile('spendly_transactions.csv', "\uFEFF"+csv, 'text/csv;charset=utf-8');
        }
    }

    function downloadFile(filename, text, type) {
        const blob = new Blob([text], { type: type });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importData(event) {
        const file = event.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                if(file.name.endsWith('.json')) {
                    const data = JSON.parse(e.target.result);
                    if(data.transactions) {
                        appData.transactions = [...appData.transactions, ...data.transactions];
                        appData.credits = data.credits ? [...appData.credits, ...data.credits] : appData.credits;
                        saveLocally();
                        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
                        initMainInterface();
                    }
                } else {
                    alert("–ü–æ–¥–¥–µ—Ä–∂–∫–∞ CSV –∏–º–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ JSON.");
                }
            } catch(err) {
                alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.");
            }
        };
        reader.readAsText(file);
    }

    // Boot
    window.onload = initApp;

</script>
</body>
</html>
